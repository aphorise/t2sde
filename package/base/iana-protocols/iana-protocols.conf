# --- T2-COPYRIGHT-NOTE-BEGIN ---
# T2 SDE: package/*/iana-protocols/iana-protocols.conf
# Copyright (C) 2024 The T2 SDE Project
# 
# This Copyright note is generated by scripts/Create-CopyPatch,
# more information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2.
# --- T2-COPYRIGHT-NOTE-END ---

autoextract=0
runconf=0
runmake=0

hook_add inmake 5 iana_protocols_inmake

iana_protocols_inmake() {
	local iana_protocols=$(match_source_file -p protocol-numbers.xml)
	local iana_ports=$(match_source_file -p service-names-port-numbers.xml)

	mkdir -p $root$datadir/iana/
	install -Dm644 $iana_ports $iana_protocols $root$datadir/iana/

	gawk -F"[<>]" '
BEGIN { print "# Full data: /usr/share/iana/protocol-numbers.xml\n" }
(/<record/) { v=n="" }
(/<value/) { v=$3 }
(/<name/ && $3!~/ /) { n=$3 }
(/<\/record/ && n && v!="") { printf "%-12s %3i %s\n", tolower(n),v,n }
' $iana_protocols > $root$sysconfdir/protocols

	gawk -F"[<>]" '
BEGIN { print "# Full data: /usr/share/iana-etc/port-numbers.xml\n" }
(/<record/) { n=u=p=c="" }
(/<name/ && !/\(/) { n=$3 }
(/<number/) { u=$3 }
(/<protocol/) { p=$3 }
(/Unassigned/ || /Reserved/ || /historic/) { c=1 }
(/<\/record/ && n && u && p && !c) { printf "%-15s %5i/%s\n", n,u,p }
' $iana_ports > $root$sysconfdir/services

}
